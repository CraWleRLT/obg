<!DOCTYPE html>
<html>
<head>
	<title>Hanabi Lobby</title>
	<script src="/js/socket.io.js"></script>
	<script src="/js/game_init.js"></script>
	<script>

function parseUriSearchString (str) {
	// Remove leading questionmark
	if (str.charAt(0) == '?') {
		str = str.slice(1);
	}

	// Split up strings in the form of "foo=bar&baz=bat" into
	// objects {foo: 'bar', baz: 'bat'}
	var ret = {}
	str.split('&').forEach(function(s){
		var vals = s.split('=');
		ret[decodeURI(vals[0] || '')] = decodeURI(vals[1] || '')
	});
	return ret;
	}



window.onload = function() {
	// grab the name and room from the URI search string, or put
	// in some defaults if they're not given.
	var args = parseUriSearchString(window.location.search);
	var name = args.name || 'Tom';
	var id = null;
	var room = args.room || 'innercircle';
	if (!args.name || !args.room) {
		window.location.search = "?name=" + encodeURI(name) + "&room=" + encodeURI(room);
	}
	
	// take a game object game and start the game
	function startNewGame(game) {
		console.log('got new game data. starting new game');
		document.querySelector('#lobby').setAttribute('style', 'display: none')
		document.querySelector('#game-screen').setAttribute('style', '')
		gameMode(name, id, game, socket);
		
	}

	console.log(args)

	document.querySelector('#name').innerHTML = name;
	document.querySelector('#room').innerHTML = room;
	var messagesDiv = document.querySelector('#messages');

	// Set up the web socket
	var socket = io.connect();
	window.ss = socket;
	socket.on('connect', function () {
		console.log('connected');
		// Set our name
		socket.emit('set-name', name);
		// Join the appropriate room as soon as we've connected
		socket.emit('set-room', room);
		// Get our ID from the server so we know where we
		// show up in the list of people in our room
		socket.emit('query-id');
	});
	socket.on('message', function(data) {
		console.log('Got data', data.message);
		if (data.message.type == 'new-game') {
			startNewGame(data.message.game);	
		}
	});
	//lists all the client and room data
	//the rooms are links to the room in question.
	//
	
	var readyState = false;
	document.querySelector('#setReadyState').addEventListener('click', function () {
		readyState = !readyState;
		if (readyState == false){
 			setReadyState.innerHTML = "I\'m ready!";
 		}else{
 			setReadyState.innerHTML = "I\'m not ready!";
 		}
		socket.emit('set-data', {readyState: readyState});

	});
	
	socket.on('room-info', function(data) {
		var everyoneReady = true;
		var i;
		var j;
		console.log('Room info:', data);
		messagesDiv.innerHTML = "<div id = 'titles'>Users in the Room:</div>"	
		
		for (i = 0; i < data.clients.length; i++){
			everyoneReady = everyoneReady & !!(data.clients[i].data.readyState);
			if (data.clients[i].data.readyState == true){
				messagesDiv.innerHTML += "<span style='color:green;'> &bull;</span>"
			}else{
				messagesDiv.innerHTML += "<span style='color:red;'> &bull;</span>"
			}
			messagesDiv.innerHTML += data.clients[i].name + '<br>'
		}
		
		messagesDiv.innerHTML += "<div id = 'titles'>Available rooms:</div>"
		for (i = 1; i < data.roomList.length; i++){
			var roomName = data.roomList[i].replace(/^\//, '')
			messagesDiv.innerHTML += "<a href='?name=" + name + "&room=" + roomName + "' >" + roomName + "</a><br>"
		}

		// If we are the first person on the list, we are the leader of the room,
		// so we should start the game.
		if (name == data.clients[0].name) {
			// If there is more than one person in the room and everyone
			// is ready, then let's start the game.
			if (data.clients.length > 1 && everyoneReady) {
				console.log('LEADER: everyone is ready')
				// We're the leader and everyone is ready, so 
				// prep the game object and broadcast it to everyone
				var game = prepGame(data);
				socket.emit('broadcast', {type: 'new-game', game: game});
				startNewGame(game);

			} else {
				console.log('LEADER: not everyone is ready')
			}
		}
	
	});
	socket.on('id-info', function(data) {
		console.log('Id info:', data);
		name = data.name;
		id = data.id;
	});
	
	// change function sets the name to the value in the setname box
	// it also sets the room to the text in the room box
	var change = function ()
	{
		if (document.querySelector('#setName').value){		
			name = document.querySelector('#setName').value;
		}
		if (document.querySelector('#roomName').value){
			room = document.querySelector('#roomName').value;
		}
		window.location.search = "?name=" + encodeURI(name) + "&room=" + encodeURI(room);
		socket.emit('set-name', name);
	}

	// lets the user input using enter
	var enterData = function (event) 
	{
		if(event.keyCode == 13)
		{
			change();
		}
	}

	//set ups is the button that sets the room and user data when clicked it runs the change function which sets the information in the URL
	//The 'setname' and 'roomname' functions are for the ability to press enter in either the set name or set room text inputs
	document.querySelector('#setUps').addEventListener('click', change);
	document.querySelector('#setName').addEventListener('keydown', enterData);
	document.querySelector('#roomName').addEventListener('keydown', enterData);

};
// prepare a game object for the players listed in roomInfo
function prepGame(roomInfo) {
	var game = createNewGame(roomInfo.clients.length);
	
	for (i = 0; i < roomInfo.clients.length; i++){
		player = roomInfo.clients[i];
		game.players[i].name = player.name;
		game.players[i].id = player.id;
	}

	return game;
}

// cheap hack so we can use all the function Andrei already made for us.
function gameMode(name, id, game, socket) {
	function broadcastNewGameState() {
		socket.emit('broadcast', {type: 'new-game', game: game});
	}
	function getPlayerById(game, id) {
		for (var i = 0; i < game.players.length; i++) {
			if (game.players[i].id == id) {
				return game.players[i];
			}
		}
	}

	// moved this from the individual functions it assumes we are the first player we need to make the names the same in order for the 
		//discard
		//updateScreen
	//functions to work, if you make a functions that requires this information make sure to add it here

	var myId = id;
	var others = []
	for (var i = 0; i < game.players.length; i++) {
		if (game.players[i].id != myId) {
			others.push(game.players[i]);
		}
	}
	var inAction = false;
	
	// set up the active players hand
	var me = getPlayerById(game, myId);
	
	/*These are the player actions, clicking on a cars activates either the
	  clue action or the play card action*/

	//if a card in another players hand is clicked then the option to give clues comes up
	function clue(event){
		var target = event.currentTarget;
		var cardname = (target.src.replace(/^.*[\\\/]/, '')).replace(/.png/, '');
		var cardNumber = cardname.substring(0,1)	
		var cardColor = cardname.substring(2);
		var s = "";
		s += "<ul><li class='tellColor' title="+ target.title.substring(5) + ">Tell " + cardColor + "</li>";
		s += "<li class='tellNumber' title=" + target.title.substring(5) + ">Tell " + cardNumber + "</li>";
		s += "<li class= 'cancel'>Cancel</li><ul>";
		document.querySelector('#instruction').innerHTML = s;
		document.querySelector('.tellColor').style.background = cardColor;
		addInstructionListner();
	}

	function setKnowledgeColor(event){
		var target = event.currentTarget;
		var player = others[target.title];
		var info = target.innerHTML.substring(5);
		for (var i = 0; i < player.hand.length;i++){
			if(player.hand[i].color != info){
				player.hand[i].impossible.push(info);
			}else{
				var possibleKnowledge = ['red','green','blue','yellow','black'];
				for(var j = 0; j < possibleKnowledge.length; j++){
					if (info != possibleKnowledge[j] && player.hand[i].impossible.indexOf(info) == -1){
						player.hand[i].impossible.push(possibleKnowledge[j]);
					}
				}
			}
		}
		if(game.clueTokens > 0)
			game.clueTokens--;
		broadcastNewGameState()
		updateScreen(game);
		clearInstructions();
	}

	function setKnowledgeNumber(event){
		var target = event.currentTarget;
		var player = others[target.title];
		var info = target.innerHTML.substring(5);
		console.log(info);
		for (var i = 0; i < player.hand.length;i++){
			if(player.hand[i].number != info){
				player.hand[i].impossible.push(info);
			}else{
				var possibleKnowledge = ['1','2','3','4','5'];
				for(var j = 0; j < possibleKnowledge.length; j++){
					if (info != possibleKnowledge[j] && player.hand[i].impossible.indexOf(info) == -1){
						player.hand[i].impossible.push(possibleKnowledge[j]);
					}
				}
			}
		}
		if(game.clueTokens > 0)
			game.clueTokens--;
		broadcastNewGameState()
		updateScreen(game);
		clearInstructions();
	}

	//When a card in your hand is clicked it draws the discard and play options to the screen
	function myHandAction(event){
		var target = event.currentTarget.title;
		console.log(target);
		var s = "";
		s += "<ul><li class='playCard' title =" + target + ">Play Card</li>";
		s += "<li class='discardCard' title =" + target + ">Discard Card</li>";
		s += "<li class= 'cancel'>Cancel</li><ul>";

		var instructions = document.querySelector('#instruction')
		instructions.innerHTML = s;
		addInstructionListner();		
	}

	// plays the selected card
	function play(event){

		if(me.hand.length != 0){
			var cardNumber = event.currentTarget.title;
			var playedCard = me.hand.splice(cardNumber, 1)[0];	
			var cardNum = game.tableau[sortColor(playedCard.color)].length;
			if(playedCard.number == cardNum + 1){
				addSort(playedCard, game.tableau);
			}else{
				if(game.hearts > 0) game.hearts--;
				addSort(playedCard, game.discard);
			}
			me.hand.push(game.deck.pop());
			broadcastNewGameState()
			updateScreen(game);
			clearInstructions();
		}
	}

	//discard from the hand, checks if there are any cards left in the hand before running
	function Discard(event){
		if(me.hand.length != 0){
			var cardNumber = event.currentTarget.title;
			addSort(me.hand.splice(cardNumber, 1)[0], game.discard);
			me.hand.push(game.deck.pop());
			if(game.clueTokens < 8) game.clueTokens++;
			broadcastNewGameState()
			updateScreen(game);
			clearInstructions();
		}
	}

	function addInstructionListner(){
		if (document.querySelector('.tellNumber'))
			document.querySelector('.tellNumber').addEventListener('click',  setKnowledgeNumber);
		if (document.querySelector('.tellColor'))
			document.querySelector('.tellColor').addEventListener('click', setKnowledgeColor);
		if(document.querySelector('.discardCard'))
			document.querySelector('.discardCard').addEventListener('click', Discard);
		if (document.querySelector('.playCard'))
			document.querySelector('.playCard').addEventListener('click', play);
		if (document.querySelector('.cancel'))
			document.querySelector('.cancel').addEventListener('click', clearInstructions);
	}

	function clearInstructions(){
		var s = '';
		document.querySelector('#instruction').innerHTML = s;
	}

	// returns a list of classes corresponding to
	// what is known about this card
	function getKnowledgeClasses(card) {
		var possibleKnowledge = ['red','green','blue','yellow','black','1','2','3','4','5'];
		var ret = [];
		for (var i = 0; i < possibleKnowledge.length; i++) {
			var possibility = possibleKnowledge[i];
			if ((card.impossible.indexOf(possibility)) == -1) {
				ret.push("maybe-" + possibility);
			}
		}
		return ret;
	}

	//enumerate sorting sorting {[red], [green], [blue], [yellow], [black]
	//could be probably be an enumeration if that is supported...
	function sortColor(color){
		if (color == 'red')
			return 0;
		if (color == 'green')
			return 1;
		if (color == 'blue')
			return 2
		if (color == 'yellow')
			return 3
		if (color == 'black')
			return 4;
		// if we include a rainbow color
		else
			return 5;
			
	}

	//sorts in order into arrays by their color
	//assumes the sort destination is already set up to be sorted
	// in our case it can only be used on tableau and discard
	function addSort(card, sortdestination){
		//insert into the appropriate part of the array
		var toSort = sortdestination[sortColor(card.color)];
		toSort.push(card);
		var swapped;
		do {
			swapped = false;
			for (var i=0; i < toSort.length-1; i++) {
			    if (toSort[i].number > toSort[i+1].number) {
				var temp = toSort[i];
				toSort[i] = toSort[i+1];
				toSort[i+1] = temp;
				swapped = true;
			    }
		}
	    } while (swapped);
	}


	// generates the discard pile and the tableau
	function setupCards(hand, parent) {
		var s = "<ul>";
		if(hand){
			for (var i = 0; i < hand.length; i++) {
				if(hand[i]){
					for (var j = 0; j < hand[i].length; j++){
						s += "<li><img class='card' src='/images/cards/" + hand[i][j].number + "-" + hand[i][j]	.color + ".png' />";
						s += "</div>";
						s += "</li>";
					}
		}
			}
		}
		s += "</ul>";
		parent.innerHTML = s;
	}

	// hand is the players hand, parent is the div
	// that all the cards should be displayed in.
	function setupHand(hand, parent) {
		var s = "<ul>";
		for (var i = 0; i < hand.length; i++) {
			s += "<li><img class='card' src='/images/cards/" + hand[i].number + "-" + hand[i].color + ".png' title=" + parent.parentNode.id + " />";
			// put all the information we know about possibilities for the card in one place
			s += "<div class='knowledge'>";
			for (var j=0, classList = getKnowledgeClasses(hand[i]); j < classList.length; j++) {
				var knowledgeClass = classList[j];
				s += "<div class='" + knowledgeClass +"'></div>"
			}
			s += "</div>";
			s += "</li>";

			}	
		parent.innerHTML = s;
	}
	// hand is the players hand, parent is the div
	// that all the cards should be displayed in

	// might be a better way to do this without using the title as the position but I couldnt see it

	function setupMyHand(hand, parent) {
		var s = "<ul>";
		for (var i = 0; i < hand.length; i++) {
			//uncomment this line and comment the one below it to see the card displayed
			//s += "<li><img class='card' src='/images/cards/" + hand[i].number + "-" + hand[i].color + ".png' title=" + i + " />";
			s += "<li><div class='card' title =" + i + ">???</div>"
			// put all the information we know about possibilities for the card in one place
			s += "<div class='knowledge'>";
			for (var j=0, classList = getKnowledgeClasses(hand[i]); j < classList.length; j++) {
				var knowledgeClass = classList[j];
				s += "<div class='" + knowledgeClass +"'></div>"
			}
			s += "</div>";
			s += "</li>";
		}
		s += "</ul>";
		parent.innerHTML = s;
	}

	//updates all data on the screen others variable is global and should be defined properly before project is done
	function updateScreen(game){
		//setup your hand
		setupMyHand(me.hand, document.querySelector('#myHand .handContents'));
		// set up the other player's hands
		for (var i = 0; i < others.length; i++) {
			var other = others[i];
				document.querySelector('#other' + i + ' .playerName').textContent = other.name;
			setupHand(other.hand, document.querySelector('#other' + i + ' .handContents'));
		}

		// display the heart tokens
		document.querySelector('.heartsDisplay').innerHTML = game.hearts;
		// display the clue tokens
		document.querySelector('.cluesDisplay').innerHTML = game.clueTokens;
		// display the discard hand
		setupCards(game.discard,  document.querySelector('#discard'));
		setupCards(game.tableau,  document.querySelector('#tableau'));
		//could put some sort of toggle here to make these only happen if it is your turn.
		var cards = document.querySelectorAll('#myHand .handContents .card')
		for (var i=0; i < cards.length; i++) {
			var card = cards[i];
			card.addEventListener('click', myHandAction);
		}
		cards = document.querySelectorAll('#othersHands .card');
		for (var i=0; i < cards.length; i++) {
			var card = cards[i];
			card.addEventListener('click', clue);
		}

	}



	updateScreen(game)
	// for debug perposes, make the game globally accessible
	window.gameObject = game;

}




	</script>
</head>
<body>
	<!-- should only be displayed when in the lobby -->
	<div id="lobby">
		<div id="wrapper">
			<h1>Hanabi Lobby</h1>
			<p> Click on a room to join!<br>Or create a new one!</p>
			Name: <span id="name" style="color: blue;"></span>
			Current room: <span id="room" style="color: blue;"></span><br>
			Set Username: <input type = "text" id="setName"><br>
			Change room: <input type = "text" id ="roomName"><br>
			<button id="setUps">Set</button><button id="setReadyState"> I'm Ready! </button>
		</div>
		<div id="messages" style="border: 1px solid black;"></div>
	</div>
	<!-- should only be displayed when game is active -->
	<div id="game-screen" style="display: none">
		<style>
			.handDisplay {
				min-height: 100px;
				background: #aaa;
				display: inline-block;
			}
			.handDisplay li {
				display: inline-block;
				margin-right: 5px;
			}
			.discardDisplay {
				min-height: 100px;
				background: #aaa;
				margin: 5px;
				display: inline-block;
			}
			.discardDisplay li {
				display: inline-block;
				margin-right: 5px;
			}
			.stacked li{
				position:relative;
				display:block;
			}

			.card {
				background: #fff;
				border-radius: 10px;
				border: 1px solid #555;
				transition: box-shadow .2s;
				width: 80px;a
				height: 125px;
			}
			.card:hover {
				box-shadow: 0px 0px 10px #444;
			}

			.card.selected {
				box-shadow: 0px 0px 5px #00f;
			}
			.card.selected:hover {
				box-shadow: 0px 0px 10px #00f;
			}
			#hearts {
				background-image: url('../images/heart.svg');
				width: 100px;
				height: 100px;
				background-size: 100% 100%;
				position: relative;
			}
			#hearts .heartsDisplay {
				color: white;
				font-size: 30px;
				padding-top: 30%;
				text-align: center;
				font-weight: bold;
				font-family: sans-serif;
				text-shadow: 0px 0px 4px #faa;
			}
			#clues {
				background-image: url('../images/clues.png');
				width: 100px;
				height: 100px;
				background-size: 100% 100%;
				position: relative;
			}
			#clues .cluesDisplay {
				color: white;
				font-size: 30px;
				padding-top: 30%;
				text-align: center;
				font-weight: bold;
				font-family: sans-serif;
				text-shadow: 0px 0px 4px #00FF21;
			}

			/* potential knowledge classes */
			.knowledge:before {
				content: 'Could Be:';
				font-size: small;
				font-style: italic;
				font-family: sans-serif;
			}
			.maybe-red:after {
				content: 'Red';
				display: block;
				color: red;
			}
			.maybe-blue:after {
				content: 'Blue';
				display: block;
				color: blue;
			}
			.maybe-green:after {
				content: 'Green';
				display: block;
				color: green;
			}
			.maybe-black:after {
				content: 'Black';
				display: block;
				color: black;
			}
			.maybe-yellow:after {
				content: 'Yellow';
				display: block;
				color: yellow;
			}
			.maybe-1, .maybe-2, .maybe-3, .maybe-4, .maybe-5 {
				display: inline;
				margin-right: 3px;
			}
			.maybe-2:after {
				content: '2';
			}
			.maybe-3:after {
				content: '3';
			}
			.maybe-4:after {
				content: '4';
			}
			.maybe-5:after {
				content: '5';
			}
			.maybe-1:after {
				content: '1';
			}
			.maybe-2:after {
				content: '2';
			}
			.maybe-3:after {
				content: '3';
			}
			.maybe-4:after {
				content: '4';
			}
			.maybe-5:after {
				content: '5';
			}
			.instructionDisplay li {
				display: inline-block;
				margin-right:20px;
				width:220px;
				padding:10px;
				border:2px solid black;
				background-color: white;
				z-index:1;
				font-size: 30px;
				background: 'white';
				border: 'black'
			}

			#instruction { 
				position: fixed;
				bottom:0px;
			}		
			.tellColor{
				color: white;
			}
					
		</style>

		</head>
			<h1>Hanabi</h1>
			<div id="tableau" class= "handDisplay">tableu</div>
			<div id="myHand" class="handDisplay">myHand
				<h4 class="playerName"></h4><div class="handContents"></div>
			</div>
			<div id="othersHands">othersHands
				<div id="other0" class="handDisplay">
					<h4 class="playerName"></h4>
					<div class="handContents"></div>
				</div>
				<div id="other1" class="handDisplay">
					<h4 class="playerName"></h4><div class="handContents"></div>
				</div>
				<div id="other2" class="handDisplay">
					<h4 class="playerName"></h4><div class="handContents"></div>
				</div>
			</div>
			<div id="hearts"><div class="heartsDisplay"></div></div>
			<div id="clues"><div class="cluesDisplay"></div></div>
			<div id="discard" class="discardDisplay">discard</div>
			<div id="instruction" class="instructionDisplay"></div>
	</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
   	<script src="js/bootstrap.min.js"></script>
</body>
<style>
	
	#messages {
		border: 1px solid black;
		width: 250px;
		margin-left: auto;
		margin-right: auto;
		font-family: calibri;
		}
		
	#titles {
		text-align: center;
		font-size: 18px;
		
	

</style>
</html>
